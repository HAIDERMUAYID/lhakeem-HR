# خطة تنفيذ: أجهزة البصمة ومعرف البصمة للموظفين

## الهدف
- **معرف البصمة (Fingerprint ID)**: يكون **فريداً على مستوى الجهاز** فقط (نفس الرقم مسموح على أجهزة مختلفة).
- **أجهزة البصمة**: صفحة إدارة أجهزة الحضور (مثل صفحة الموظفين/الأقسام).
- عند إضافة موظف (أو تعديله): إمكانية ربطه بأجهزة متعددة، لكل جهاز معرف بصمة مختلف، مع التحقق من عدم تكرار نفس المعرف على **نفس الجهاز**.

---

## 1. نموذج البيانات (Schema)

### 1.1 جدول `Device` (جهاز البصمة)
| الحقل | النوع | الوصف |
|-------|------|--------|
| id | String (cuid) | معرف فريد |
| name | String | اسم الجهاز (مثل: جهاز الإدارة، جهاز الطوارئ) |
| code | String? | كود أو رمز اختياري (مثل: ADM-01) |
| location | String? | الموقع اختياري |
| isActive | Boolean | تفعيل/إيقاف الجهاز |
| createdAt, updatedAt | DateTime | |

- **الفكرة**: كل جهاز بصمة حقيقي يُسجَّل كسجل واحد. لا يوجد علاقة بالأقسام في الـ schema الحالي؛ يمكن لاحقاً ربط الجهاز بقسم إن رغبت.

### 1.2 جدول `EmployeeFingerprint` (ربط الموظف بمعرف البصمة على جهاز)
| الحقل | النوع | الوصف |
|-------|------|--------|
| id | String (cuid) | معرف فريد |
| userId | String | الموظف |
| deviceId | String | الجهاز |
| fingerprintId | String أو Int | رقم المعرف كما يظهر على الجهاز (يفضل String لمرونة أجهزة مختلفة) |
| createdAt, updatedAt | DateTime | |

- **قيد فريد (Unique)**: `@@unique([deviceId, fingerprintId])`
  - معنى القيد: على **نفس الجهاز** لا يمكن أن يُستخدم نفس `fingerprintId` لموظفين مختلفين.
  - نفس الموظف يمكن أن يكون له أكثر من سجل (جهاز إدارة → 7، جهاز طوارئ → 7 أو أي رقم آخر).

- **العلاقات**:
  - `User` ← one-to-many → `EmployeeFingerprint`
  - `Device` ← one-to-many → `EmployeeFingerprint`

---

## 2. التحقق (Validation) عند الإدخال

- عند **إضافة** أو **تعديل** ربط (جهاز + معرف بصمة) لموظف:
  1. التحقق من وجود الجهاز وأنه مفعّل.
  2. التحقق من أن الثنائية `(deviceId, fingerprintId)` **غير مستخدمة** لموظف آخر (إن وُجد سجل قديم لنفس الموظف نستثنيه عند التعديل).
- في الـ API: إذا كان المعرف مستخدماً على هذا الجهاز لموظف آخر → إرجاع خطأ واضح (مثل 409 أو 400 مع رسالة بالعربية).

---

## 3. واجهات الـ API

### 3.1 أجهزة البصمة (Devices)
| Method | المسار | الوظيفة |
|--------|--------|----------|
| GET | `/api/devices` | جلب كل الأجهزة (أو المفعّلة فقط حسب الحاجة) |
| POST | `/api/devices` | إضافة جهاز جديد |
| PUT | `/api/devices/[id]` | تعديل جهاز |
| DELETE | `/api/devices/[id]` | حذف جهاز (انتباه: إن كان مرتبطاً ببصمات موظفين يمكن منع الحذف أو جعل الحذف soft) |

### 3.2 بصمات الموظف (Employee Fingerprints)
| Method | المسار | الوظيفة |
|--------|--------|----------|
| GET | `/api/users/[userId]/fingerprints` | جلب كل أجهزة البصمة ومعرفاتها لهذا الموظف |
| POST | `/api/users/[userId]/fingerprints` | إضافة ربط (deviceId + fingerprintId) مع التحقق من التفرد على الجهاز |
| DELETE | `/api/users/[userId]/fingerprints/[fingerprintRecordId]` | إزالة ربط جهاز–معرف عن الموظف |

- **تحقق في POST**: قبل الإدراج التحقق من عدم وجود `(deviceId, fingerprintId)` لموظف آخر؛ إن وُجد → 400/409 مع رسالة مناسبة.

---

## 4. الواجهات (Pages / UI)

### 4.1 صفحة الأجهزة `/devices`
- **القائمة**: جدول أجهزة البصمة (الاسم، الكود، الموقع، مفعّل/غير مفعّل، تاريخ الإضافة إن رغبت).
- **إضافة جهاز**: نموذج (اسم، كود اختياري، موقع اختياري، مفعّل).
- **تعديل جهاز**: نفس الحقول.
- **حذف**: مع تأكيد؛ إن كان الحذف ممنوعاً عند وجود بصمات مرتبطة، إظهار رسالة واضحة.

يمكن جعل التصميم والأسلوب مطابقاً لصفحة الموظفين (نفس الـ Card، Table، Dialog، أزرار).

### 4.2 صفحة الموظفين (تعديل)
- في نموذج **إضافة موظف**: بعد الحقول الحالية (الاسم، البريد، المسمى، المدير) إضافة قسم **"معرفات البصمة"**:
  - اختيار **جهاز** من قائمة الأجهزة.
  - إدخال **معرف البصمة** (رقم أو نص حسب ما يدعمه الجهاز).
  - زر "إضافة معرف" يضيف السطر إلى قائمة مؤقتة ثم عند الحفظ نرسل بيانات الموظف + قائمة البصمات.
- في **عرض/تعديل موظف** (إن وُجدت صفحة تفاصيل أو تعديل):
  - عرض جدول: جهاز | معرف البصمة | إجراء (حذف).
  - إضافة سطر جديد: جهاز + معرف، مع التحقق قبل الحفظ أن هذا الجهاز لا يحتوي بالفعل على هذا المعرف لموظف آخر.

- **التحقق من التفرد**: عند إضافة (جهاز + معرف) إما:
  - استدعاء API للتحقق قبل الإرسال النهائي، أو
  - إرسال مع الحفظ والـ API يرجع خطأ في حال التكرار؛ نعرض الرسالة للمستخدم.

---

## 5. ترتيب التنفيذ المقترح

1. **تعديل Prisma Schema**
   - إضافة نموذج `Device`.
   - إضافة نموذج `EmployeeFingerprint` مع العلاقات والـ `@@unique([deviceId, fingerprintId])`.
   - تشغيل `npx prisma migrate dev` وتحديث العميل.

2. **Seed (اختياري)**
   - إن وُجد `seed.ts` إضافة جهازين نموذجيين (مثل الإدارة والطوارئ) لتجربة الواجهة.

3. **API الأجهزة**
   - إنشاء `src/app/api/devices/route.ts` (GET, POST).
   - إنشاء `src/app/api/devices/[id]/route.ts` (GET, PUT, DELETE).

4. **صفحة الأجهزة**
   - إنشاء `src/app/devices/page.tsx` (قائمة + إضافة + تعديل + حذف) بنفس أسلوب صفحة الموظفين.

5. **API بصمات الموظف**
   - إنشاء `src/app/api/users/[userId]/fingerprints/route.ts` (GET, POST).
   - إنشاء `src/app/api/users/[userId]/fingerprints/[recordId]/route.ts` (DELETE).
   - تنفيذ التحقق من تفرد (deviceId, fingerprintId) في POST.

6. **تعديل صفحة الموظفين**
   - إضافة قسم "معرفات البصمة" في نموذج إضافة موظف (جهاز + معرف، مع إمكانية أكثر من سطر).
   - عند الحفظ: إنشاء الموظف ثم إنشاء سجلات `EmployeeFingerprint`.
   - (اختياري) إضافة صفحة أو Dialog لتعديل الموظف وعرض/إضافة/حذف البصمات.

7. **الرابط من الصفحة الرئيسية**
   - إضافة رابط "الأجهزة" أو "أجهزة البصمة" في الصفحة الرئيسية بجانب الموظفين والجداول الأخرى.

---

## 6. إضافات مقترحة (اختيارية لاحقاً)

- **تسجيل الجهاز عند الحضور**: إذا أردت لاحقاً تسجيل من أي جهاز تمت عملية الحضور، يمكن إضافة `deviceId` (اختياري) في `AttendanceLog` واستخدام معرف البصمة + الجهاز للتعرف على الموظف عند الاستعلام.
- **ربط جهاز بقسم**: إن كان لديك جدول أقسام لاحقاً، إضافة `departmentId` في `Device` يسهل تصفية الأجهزة حسب القسم.
- **تصدير قائمة البصمات لكل جهاز**: تقرير أو تصدير (جهاز → قائمة معرفات مع أسماء الموظفين) لتسهيل المطابقة مع إعدادات أجهزة البصمة الفعلية.

---

## 7. ملخص القيود

| القيد | التطبيق |
|-------|----------|
| معرف البصمة فريد على الجهاز فقط | `@@unique([deviceId, fingerprintId])` في `EmployeeFingerprint` |
| عدم قبول تكرار (جهاز + معرف) لموظف آخر | التحقق في API قبل الإدراج وإرجاع خطأ واضح |
| صفحة أجهزة مثل الأقسام | صفحة `/devices` مع CRUD كامل |
| إضافة معرف البصمة عند إضافة موظف | قسم في نموذج الموظف: اختيار جهاز + إدخال معرف، مع التحقق |

بعد الموافقة على هذه الخطة يمكن البدء بالتنفيذ خطوة بخطوة (Schema → APIs → صفحة الأجهزة → APIs البصمات → تعديل صفحة الموظفين → الربط في الصفحة الرئيسية).
