# خطة: إدارة الموظفين من صفحة الجهاز وصفحة القسم

## الهدف
- **صفحة الجهاز:** عند الدخول إلى جهاز → عرض الموظفين المربوطين به، مع إضافة (واحد أو عدة)، تعديل معرف البصمة، حذف. مع التعامل الذكي عند ربط موظف مرتبط بجهاز آخر (نقل / إضافة على الجهازين / تراجع).
- **صفحة القسم:** نفس الفكرة مع عرض موظفي القسم، إضافة/نقل موظفين، مع قيد «موظف واحد في قسم واحد» (نقل فقط أو إلغاء).
- ضمان عدم تكرار معرف البصمة على نفس الجهاز، وواجهة سريعة وسهلة.

---

## الجزء الأول: أجهزة البصمة

### 1.1 سلوك الصفحة
- **الدخول إلى الجهاز:** النقر على بطاقة الجهاز (أو زر «عرض الموظفين») يفتح **صفحة تفصيل الجهاز** أو **لوحة جانبية (Drawer)** تعرض:
  - اسم الجهاز ومعلوماته.
  - **جدول/قائمة الموظفين** المرتبطين به: (الاسم، العنوان، **معرف البصمة على هذا الجهاز**)، مع أزرار **تعديل المعرف** و **حذف من الجهاز**.

### 1.2 إضافة موظفين (واحد أو عدة)
- **زر «إضافة موظفين»** يفتح نافذة فيها:
  - **اختيار موظفين:** قائمة أو بحث مع اختيار متعدد (checkbox).
  - **لكل موظف مُختار:** حقل **معرف البصمة على هذا الجهاز** (إجباري). التحقق فورياً أو عند الإرسال: عدم تكرار المعرف على نفس الجهاز.
- **إذا كان الموظف مرتبطاً بجهاز آخر:**
  - النظام يعرض رسالة واضحة: «الموظف [الاسم] مرتبط حالياً بجهاز [اسم الجهاز]. ماذا تريد؟»
  - **خيارات:**
    1. **نقله إلى هذا الجهاز فقط** → حذف ربطه من الجهاز القديم ثم إضافته على هذا الجهاز بالمعرف الجديد.
    2. **إضافته على الجهازين** → إضافة ربط على هذا الجهاز فقط (يبقى على الجهاز القديم أيضاً).
    3. **تراجع** → إلغاء إضافة هذا الموظف لهذا الجهاز والاحتفاظ به على الجهاز القديم فقط.

### 1.3 تعديل معرف البصمة
- من قائمة موظفي الجهاز: زر «تعديل» بجانب المعرف → حقل يسمح بتغيير المعرف.
- التحقق: بعد الحفظ التأكد أن المعرف الجديد غير مستخدم لموظف آخر على **نفس الجهاز**. إن كان مستخدماً → رسالة خطأ واضحة.

### 1.4 حذف موظف من الجهاز
- زر «حذف من الجهاز» → تأكيد قصير («حذف [الاسم] من هذا الجهاز؟») → إزالة الربط فقط (الموظف يبقى في النظام وعلى أي أجهزة أخرى).

### 1.5 قيود البيانات
- **الجهاز الواحد:** لا يقبل تكرار `fingerprintId` (موجود في الـ Backend كـ `@@unique([deviceId, fingerprintId])`).
- **قبل الإضافة:** يجب تحديد معرف البصمة لكل موظف؛ لا إضافة بدون معرف.

---

## الجزء الثاني: الأقسام

### 2.1 سلوك الصفحة
- **الدخول إلى القسم:** النقر على «X موظف» أو زر مماثل يفتح **تفاصيل القسم** (صفحة أو Drawer) تعرض:
  - اسم القسم ومعلوماته.
  - **جدول/قائمة الموظفين** التابعين لهذا القسم (الاسم، العنوان، إلخ) مع إمكانية **نقل الموظف إلى قسم آخر** أو **إزالته من القسم** (إن كان النموذج يسمح بذلك؛ عادة الموظف يجب أن يبقى في قسم واحد، فـ «الإزالة» = نقله لقسم افتراضي أو مطالبة المستخدم باختيار قسم).

### 2.2 إضافة/نقل موظفين إلى القسم
- **زر «إضافة موظفين إلى القسم»** أو «نقل موظفين»:
  - اختيار متعدد للموظفين (من خارج هذا القسم أو الكل).
  - **قيد:** كل موظف في **قسم واحد فقط** → المعنى: «إضافة إلى هذا القسم» = **نقل** الموظف من قسمه الحالي إلى القسم المختار.
- **عند اختيار موظف له قسم حالياً:**
  - رسالة: «الموظف [الاسم] تابع حالياً لـ [القسم]. ماذا تريد؟»
  - **خيارات:**
    1. **نقله إلى هذا القسم** → تحديث `departmentId` للموظف إلى هذا القسم.
    2. **إلغاء** → عدم تغيير قسم الموظف.

### 2.3 نقل موظف من القسم (من داخل القسم)
- من قائمة موظفي القسم: زر «نقل» بجانب الموظف → اختيار القسم الهدف → تأكيد → تحديث `departmentId`.

### 2.4 قيود البيانات
- **موظف واحد في قسم واحد:** `employee.departmentId` واحد فقط (الوضع الحالي في الـ schema).

---

## الجزء الثالث: تجربة المستخدم (UX)

### 3.1 الدخول السريع
- **الأجهزة:** النقر على البطاقة أو على «X بصمة» يفتح تفاصيل الجهاز (صفحة `/dashboard/devices/[id]` أو Drawer) دون الحاجة لخطوات إضافية.
- **الأقسام:** نفس الفكرة مع «X موظف» → صفحة `/dashboard/departments/[id]` أو Drawer.

### 3.2 الإضافة المتعددة
- نافذة واحدة: اختيار عدة موظفين + إدخال معرف البصمة (للأجهزة) لكل واحد في نفس الشاشة (جدول صغير: عمود الموظف، عمود المعرف، أو صفوف مع حقول).
- للأجهزة: معالجة «مرتبط بجهاز آخر» إما موظفاً موظفاً (نافذة اختيار لكل موظف) أو تجميع الخيارات في خطوة واحدة إن أمكن دون إرباك.

### 3.3 التعديل السريع
- **تعديل معرف البصمة:** تحرير داخل الجدول (inline) أو نافذة صغيرة بجانب الصف؛ حفظ فوري مع رسالة نجاح/خطأ.
- **نقل قسم:** قائمة منسدلة للأقسام + زر «نقل» مع تأكيد مختصر.

### 3.4 التأكيدات
- حذف من الجهاز: «حذف [الاسم] من هذا الجهاز؟ لن يُحذف الموظف من النظام.»
- نقل القسم: «نقل [الاسم] إلى [القسم]؟»

### 3.5 الرسائل
- عند رفض تكرار المعرف على الجهاز: «معرف البصمة [X] مستخدم على هذا الجهاز للموظف [الاسم]. اختر معرفاً آخر.»
- عند نجاح الإضافة/التعديل/الحذف: رسالة قصيرة واضحة.

---

## الجزء الرابع: الـ Backend المطلوب

### 4.1 أجهزة البصمة (مكملات)
- **تعديل معرف البصمة:**  
  `PATCH` أو `PUT`  
  ` /api/employees/:employeeId/fingerprints/:recordId`  
  Body: `{ "fingerprintId": "newId" }`  
  - التحقق: أن السجل للموظف المحدد، وأن `newId` غير مستخدم على **نفس الجهاز** لموظف آخر.
- **حذف ربط من جهاز (بالـ recordId):**  
  الحالي: `DELETE /api/employees/:employeeId/fingerprints/:recordId` كافٍ (مع التحقق أن السجل يخص هذا الموظف).
- **قائمة موظفي جهاز:**  
  الحالي: `GET /api/devices/:id` يرجع الجهاز مع `fingerprints` وكل fingerprint فيه `employee`. كافٍ لعرض الموظفين ومعرفاتهم.

### 4.2 الأقسام (موجود غالباً)
- **قائمة موظفي القسم:** `GET /api/departments/:id` مع `employees` (موجود في الـ backend).
- **نقل موظف إلى قسم:** `PUT /api/employees/:id` مع `departmentId` (موجود).
- **نقل عدة موظفين:** إما عدة استدعاءات `PUT` أو endpoint واحد مثل `POST /api/departments/:id/move-employees` مع `{ "employeeIds": ["id1","id2"] }` يحدّث كل موظف إلى هذا القسم. (اختياري؛ يمكن من الواجهة استدعاء PUT لكل موظف.)

---

## الجزء الخامس: ترتيب التنفيذ المقترح

1. **Backend – أجهزة البصمة**
   - إضافة `PATCH /api/employees/:employeeId/fingerprints/:recordId` لتعديل `fingerprintId` مع التحقق من التفرد على الجهاز.

2. **Frontend – صفحة/تفاصيل الجهاز**
   - إنشاء صفحة ` /dashboard/devices/[id]` (أو Drawer من صفحة الأجهزة):
     - جلب `GET /api/devices/:id` وعرض جدول الموظفين (الاسم، المعرف) مع أزرار تعديل المعرف وحذف من الجهاز.
     - زر «إضافة موظفين» يفتح نافذة: اختيار متعدد + حقل معرف لكل موظف؛ عند الإرسال التحقق من التكرار ومعالجة «مرتبط بجهاز آخر» (نقل / إضافة على الجهازين / تراجع).

3. **Frontend – تعديل معرف البصمة**
   - في جدول موظفي الجهاز: زر تعديل → حقل جديد للمعرف → استدعاء PATCH ثم تحديث القائمة.

4. **Frontend – الأقسام**
   - تفاصيل القسم (صفحة أو Drawer): عرض موظفي القسم من `GET /api/departments/:id`.
   - زر «نقل موظفين إلى هذا القسم»: اختيار متعدد للموظفين؛ إن كان الموظف في قسم آخر إظهار خيار «نقله إلى هذا القسم» أو «إلغاء» ثم استدعاء `PUT /api/employees/:id` مع `departmentId` الجديد.
   - من داخل القسم: زر «نقل» بجانب كل موظف → اختيار القسم الهدف → PUT.

5. **تحسينات نهائية**
   - رسائل تأكيد موحدة، ومعالجة أخطاء الشبكة، وتحديث القوائم بعد كل عملية.

---

## ملخص القيود والسلوك

| الموضوع | القيد / السلوك |
|--------|-----------------|
| معرف البصمة على الجهاز | فريد على الجهاز فقط؛ التحقق عند الإضافة وعند التعديل. |
| موظف على أكثر من جهاز | مسموح؛ نفس الموظف يمكن أن يكون له معرف على جهاز الإدارة وآخر على جهاز الطوارئ. |
| إضافة موظف لجهاز وهو على جهاز آخر | خيارات: نقل فقط، إضافة على الجهازين، تراجع. |
| موظف في الأقسام | قسم واحد فقط؛ «الإضافة» من صفحة القسم = نقل إلى هذا القسم. |

بعد تنفيذ هذه الخطة ستكون إدارة الموظفين من صفحة الجهاز وصفحة القسم متسقة، واضحة، وسريعة مع مراعاة كل القيود المذكورة.
