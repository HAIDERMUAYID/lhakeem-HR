# خطة تسليم النظام وإكمال البيانات ومعاملة الموظف غير النشط

## 1. تسليم النظام والإعداد الأولي

### 1.1 ترتيب الإعداد المطلوب
1. **الأقسام أولاً** — إضافة كل الأقسام (أسماء، رموز إن وُجدت، مدير قسم إن وُجد).
2. **توزيع الموظفين على الأقسام** — إما استيراد Excel (عمود قسم = رمز القسم) أو إضافة/تعديل كل موظف وربطه بقسم.
3. **الرصيد التراكمي** — إدخال رصيد كل موظف مع **تاريخ "هذا الرصيد لغاية أي تاريخ"** ثم احتساب الرصيد الحالي تلقائياً.

### 1.2 الرصيد التراكمي — نموذج موحد (رصيد واحد)
- **عند إدخال الرصيد:** اختيار **التاريخ إجباري** — «هذا الرصيد صحيح لغاية تاريخ». النظام يحسب **مرة واحدة** الرصيد الفعلي = (القيمة المدخلة + استحقاق من ذلك التاريخ حتى يوم الإدخال − إجازات معتمدة في الفترة) ويخزّنه في `leaveBalance` ثم يمسح `balanceStartDate`.
- **بعد ذلك:** رصيد واحد مخزَن يُخصم عند اعتماد إجازات ويُزاد بالاستحقاق اليومي (مهمة يومية من الإعدادات أو cron على `POST /api/balance/daily-accrual` لجميع الموظفين النشطين).
- **الواجهة:** في إضافة/تعديل موظف: حقل **رصيد تراكمي** + حقل **هذا الرصيد صحيح لغاية تاريخ (إجباري عند إدخال رصيد)**. التحقق قبل الإرسال: إن وُجد رصيد > 0 فيجب اختيار التاريخ.
- **إضافة موظف جديد برصيد:** يُمرَّر الرصيد + التاريخ في الـ API؛ الـ backend يحسب الرصيد الفعلي ويخزنه مرة واحدة (بدون إجازات معتمدة للموظف الجديد).

---

## 2. إكمال وتحديث بيانات الموظفين (أكثر من مستخدم)

### 2.1 المشكلة
- عند الإطلاق توجد بيانات كثيرة (موظفون، أقسام، رصيد، دوام، إلخ).
- أكثر من شخص يعمل على النظام.
- لا يظهر بوضوح **من حدّث بيانات من** و**من لم تُحدَّث بعد**.

### 2.2 الحل المقترح: تتبع إكمال البيانات

#### (أ) حقل "آخر تحديث" و"من حدّث"
- في جدول الموظفين (أو في سجل تدقيق منفصل): تخزين:
  - **آخر تاريخ تحديث** لسجل الموظف (أو للرصيد فقط إن أردت تركيزاً أدق).
  - **معرّف المستخدم الذي قام بالتحديث** (إن وُجد في النظام).
- في الواجهة:
  - عمود اختياري: "آخر تحديث" و"بواسطة" في قائمة الموظفين.
  - فلتر: "لم يُحدَّث منذ X يوم" أو "بدون رصيد" لعرض من يحتاج متابعة.

#### (ب) لوحة "إكمال البيانات" (صفحة واحدة)
- صفحة واحدة (مثلاً تحت الإعدادات أو لوحة التحكم) تعرض:
  - **عدد الموظفين النشطين** الذين:
    - بدون قسم، أو
    - رصيدهم غير مُدخل (أو balanceStartDate غير معيّن)، أو
    - بدون جدول دوام للشهر الحالي (اختياري).
  - قائمة أو رابط إلى قائمة هؤلاء الموظفين لإكمال بياناتهم.
- يمكن تقسيم المهام بين المستخدمين حسب **القسم**: كل مستخدم يرى أو يُكلَّف بأقسام معيّنة.

#### (ج) تقارير سريعة ✅
- تقرير/تصدير "موظفون بدون رصيد لغاية تاريخ": عبر فلتر «من تحتاج إكمال بياناتهم» في قائمة الموظفين وزر «تصدير قائمة من تحتاج بياناتهم (CSV)» في صفحة إكمال البيانات.
- (موظفون بدون قسم: في المخطط الحالي كل موظف مرتبط بقسم؛ إن لزم تقرير «بدون قسم» لاحقاً يمكن إضافة قسم افتراضي «غير معرّف».)

### 2.3 خطة تنفيذ عملية
1. **المرحلة 1 (فوري):** ✅ تم
   - استخدام `updatedAt` الموجود في جدول الموظفين.
   - في واجهة الموظفين: عمود "آخر تحديث" وفلتر "من تحتاج إكمال بياناتهم فقط (بدون تاريخ رصيد)".
2. **المرحلة 2:** ✅ تم
   - صفحة "إكمال البيانات" (من القائمة الجانبية) تعرض: عدد النشطين، من تم إكمال بياناتهم، من لم يُحدد لهم رصيد لغاية تاريخ، ورابط إلى قائمة الموظفين بفلتر incompleteOnly.
   - API: GET `/employees/data-completion-stats` يعيد `totalActive` و `withoutBalanceDate`.
3. **المرحلة 3:** ✅ تم
   - تصفية لوحة إكمال البيانات حسب **القسم**: في صفحة «إكمال البيانات» يمكن اختيار قسم لعرض إحصائيات ذلك القسم فقط؛ الرابط إلى قائمة الموظفين يمرّر نفس القسم. المستخدمون المقيّدون بقسم يرون إحصائيات قسمهم تلقائياً (من الـ API).
   - **تصدير قائمة «من تحتاج بياناتهم» (CSV):** زر في صفحة إكمال البيانات لتصدير الموظفين الذين لم يُحدد لهم رصيد لغاية تاريخ (مع احترام فلتر القسم إن وُجد).

---

## 3. الموظف غير النشط (غير فعّال)

### 3.1 التعريف
- **غير نشط** = توقف عن الدوام (نقل، إجازة طويلة، إنهاء، إلخ) لكن نريد **الاحتفاظ بأرشيفه** (إجازات سابقة، غيابات، سجلات دوام سابقة).

### 3.2 القواعد المطلوبة

| الجانب | المطلوب |
|--------|---------|
| **الإجازات** | عدم ظهوره في قوائم "اختيار موظف" لطلب إجازة جديد. عدم إنشاء طلب إجازة جديد له. عرض طلباته السابقة (أرشيف) في التقارير وقوائم الإجازات مع إمكانية فلترة "نشط فقط". |
| **الغيابات** | عدم ظهوره في قوائم إضافة غياب. عدم تسجيل غياب جديد له. الإبقاء على أرشيف غياباته السابقة للعرض والتقارير. |
| **جداول الدوام** | عدم ظهوره في واجهات "تعيين جدول دوام" للشهر الحالي أو القادم (أو إخفاؤه افتراضياً مع خيار "عرض غير النشطين"). الاحتفاظ بجداوله السابقة للأرشيف. |
| **الرصيد التراكمي** | عدم استحقاق رصيد تراكمي له (عدم زيادة رصيده تلقائياً). عدم احتسابه في "استحقاق شهري" عند تشغيل المهمة. الإبقاء على رصيده المسجل للأرشيف دون زيادة. |

### 3.3 التنفيذ التقني (ملخص)

- **قاعدة البيانات:** الحقل `Employee.isActive` موجود — يُستخدم في كل ما يلي.
- **الاستحقاق الشهري (Balance / Accrual):** الاستعلام يقتصر على `isActive: true` (موجود في `balance.service`).
- **قوائم الموظفين:**
  - واجهات "اختيار موظف" (إجازة، غياب، جدول دوام): استدعاءات الموظفين تُرجِع فقط `isActive: true` إلا إن وُجد خيار صريح "عرض غير النشطين".
- **قوائم الإجازات والغيابات:**
  - **القائمة الافتراضية:** تصفية حسب `employee.isActive === true` حتى لا يظهر غير النشطين في العمل اليومي.
  - **تقارير/أرشيف:** إمكانية فلتر "تشمل الموظفين غير النشطين" أو "الكل" لعرض السجل التاريخي.
- **إنشاء طلب إجازة / تسجيل غياب:** التحقق من أن الموظف المختار `isActive === true`؛ إن لم يكن، رفض العملية مع رسالة واضحة.
- **واجهة الموظفين:** الإبقاء على خيار "عرض المتوقفين" و"عرض الكل" كما هو؛ صفحة ملف الموظف غير النشط تبقى قابلة للعرض للأرشيف دون السماح بإجراءات جديدة (طلب إجازة، غياب، جدول جديد).

---

## 4. خطة تنفيذ مراحل (ملخص)

| المرحلة | المحتوى | أولوية |
|---------|---------|--------|
| **أ** | منطق الرصيد "لغاية تاريخ": واجهة إدخال رصيد + تاريخ "لغاية"، وحفظهما؛ وتعديل احتساب الرصيد الحالي ليكون = رصيد مُدخل + استحقاق من ذلك التاريخ حتى اليوم. | عالية |
| **ب** | تأكيد استبعاد الموظف غير النشط من: استحقاق الرصيد، قوائم اختيار موظف (إجازة/غياب/جدول)، إنشاء طلب إجازة/تسجيل غياب؛ وإضافة فلتر "نشط فقط" في قوائم الإجازات والغيابات مع خيار "تشمل غير النشطين" للأرشيف. | عالية |
| **ج** | تتبع إكمال البيانات: عرض "آخر تحديث" و"المحدّث" في قائمة الموظفين، وفلتر "بدون رصيد" أو "بدون قسم"، وصفحة "إكمال البيانات" تعرض من لم تُكمل بياناتهم. | ✅ تم |
| **د** | تحسينات إضافية: تقارير "موظفون بدون رصيد"، تصدير CSV لقائمة من تحتاج بياناتهم، وتقسيم مهام الإكمال حسب الأقسام. | ✅ تم |

---

## 5. ملخص سريع للمستخدم

- **عند التسليم:** إضافة الأقسام → توزيع الموظفين على الأقسام → إدخال الرصيد التراكمي مع تحديد "هذا الرصيد لغاية أي تاريخ" ليُحسب الرصيد الحالي تلقائياً.
- **أكثر من مستخدم:** استخدام "آخر تحديث" ولوحة "إكمال البيانات" لمعرفة من تم تحديثه ومن لم يُحدَّث بعد.
- **الموظف غير النشط:** لا يظهر في الإجازات والغيابات والدوام الجديدة، ولا يُستحق له رصيد، مع الاحتفاظ الكامل بأرشيفه.

يمكن استخدام هذه الوثيقة كمرجع لتنفيذ التعديلات في الكود وفي إجراءات التسليم والتشغيل.

---

## 6. ما تم تنفيذه (مرجع سريع)

| البند | الحالة |
|-------|--------|
| **الرصيد «لغاية تاريخ»** | تم: في `getBalanceInfo` عند وجود `balanceStartDate` يُحسب الرصيد الحالي = الرصيد المسجّل + استحقاق من ذلك التاريخ حتى اليوم مع خصم الإجازات المعتمدة في الفترة. الموظف غير النشط لا يُضاف له استحقاق. |
| **واجهة الموظفين** | تم: حقل «هذا الرصيد التراكمي صحيح لغاية تاريخ» مع توضيح أن الرصيد المعروض = الرصيد المدخل + استحقاق حتى اليوم. |
| **قائمة طلبات الإجازات** | تم: `findAll` يفلتر افتراضياً حسب `employee.isActive === true`. يمكن إرجاع الكل (للأرشفة) بتمرير `activeOnly=false`. |
| **إنشاء طلب إجازة** | تم: التحقق من أن الموظف نشط؛ إن كان غير نشط يُرفض الطلب برسالة واضحة. |
| **إضافة غياب** | تم: `getEmployeesForOfficer` يعيد نشطين فقط؛ التحقق عند الإضافة يرفض الموظف غير النشط. |
| **استحقاق شهري** | كان مسبقاً: `runMonthlyAccrual` يقتصر على `isActive: true`. |
| **تتبع إكمال البيانات** | تم: إحصائيات إكمال البيانات (GET /employees/data-completion-stats)، فلتر «من تحتاج إكمال بياناتهم فقط» وقائمة الموظفين تعرض عمود «آخر تحديث»، وصفحة «إكمال البيانات» تعرض الإحصائيات ورابطاً إلى قائمة الموظفين بفلتر incompleteOnly. |
| **إكمال البيانات — حسب القسم** | تم: في صفحة إكمال البيانات يمكن اختيار قسم لعرض الإحصائيات لذلك القسم؛ الرابط إلى الموظفين وتمرير departmentId؛ التصدير CSV يحترم فلتر القسم. |
| **تقرير/تصدير «موظفون بدون رصيد لغاية تاريخ»** | تم: زر «تصدير قائمة من تحتاج بياناتهم (CSV)» في صفحة إكمال البيانات يصدر الموظفين النشطين الذين لم يُحدد لهم balanceStartDate. |
