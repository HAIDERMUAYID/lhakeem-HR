# خطة شاملة لتطوير نظام جداول الدوام | Work Schedules Roadmap

## نظرة عامة
نظام إدارة جداول الدوام والخفارات — مع دعم رؤية الأقسام، أنماط الخفر المتعددة، والعطل الرسمية.

---

## 1. رؤية حسب القسم (Department-based Visibility)

### 1.1 القاعدة
| الدور | ما يراه |
|-------|---------|
| **ADMIN** | جميع الموظفين وجداولهم |
| **مدير قسم (مسؤول الطوارئ)** | موظفي قسم الطوارئ فقط |
| **مدير قسم (مسؤول الجراحة)** | موظفي قسم الجراحة فقط |
| **صلاحية SCHEDULES_MANAGE** | جميع الموظفين |

### 1.2 التنفيذ
- Backend: فلترة الموظفين حسب `user.departmentId` عند عدم وجود ADMIN/SCHEDULES_MANAGE
- عرض قسم المستخدم الحالي في الهيدر
- تنبيه عند عدم وجود موظفين في القسم

---

## 2. أنواع الدوام (Work Types)

### 2.1 الدوام الصباحي (MORNING)
- أيام عمل أسبوعية ثابتة (مثال: الأحد–الخميس)
- وقت محدد: من X إلى Y مع استراحة اختيارية
- **يستفيد من العطل الرسمية** (HolidayScope: MORNING_ONLY أو ALL)

### 2.2 الخفارات (SHIFTS)
- **لا يستفيد من العطل** — يعمل في العطل كأيام عمل عادية
- أنماط الخفر:

| النمط | الوصف | مثال |
|-------|-------|------|
| **1×1** | يوم عمل، يوم استراحة | عمل، راحة، عمل، راحة... |
| **1×2** | يوم عمل، يومان استراحة | عمل، راحة، راحة، عمل... |
| **1×3** | يوم عمل، ثلاثة أيام استراحة | عمل، راحة، راحة، راحة، عمل... |
| **ثابت FIXED** | أيام أسبوعية محددة | كل سبت وثلاثاء، أو كل أربعاء |

### 2.3 وقت الدوام (لكل نوع)
- **من الساعة** (startTime)
- **إلى الساعة** (endTime)
- **استراحة** (اختياري): breakStart — breakEnd

---

## 3. تصميم قاعدة البيانات

### 3.1 تعديل WorkSchedule (Prisma)

```prisma
model WorkSchedule {
  id            String      @id @default(cuid())
  employeeId    String      @unique
  workType      WorkType    // MORNING | SHIFTS
  shiftPattern  String?     // "1x1" | "1x2" | "1x3" | "FIXED" | null (للمسائي)
  daysOfWeek    String      // للأيام الثابتة: "0,2,4" | للخفر الدوري: تاريخ بداية الدورة
  startTime     String
  endTime       String
  breakStart    String?
  breakEnd      String?
  effectiveFrom DateTime?   // بداية السريان (لنقل الموظف بين الأقسام)
  createdAt     DateTime
  updatedAt     DateTime
  employee      Employee
}
```

### 3.2 جدول قوالب الجداول (ScheduleTemplate) — اختياري
لتسريع الإدخال عند تشابه الجداول:

```prisma
model ScheduleTemplate {
  id           String   @id
  name         String   // "خفر طوارئ 1×2"
  workType     WorkType
  shiftPattern String?
  daysOfWeek   String?
  startTime    String
  endTime      String
  breakStart   String?
  breakEnd     String?
  departmentId String?  // قالب خاص بقسم
}
```

---

## 4. نقل الموظف بين الأقسام (Mid-month Transfer)

### 4.1 السلوك
- عند تغيير `employee.departmentId`:
  - الجدول القديم يبقى ساريًا حتى `effectiveTo` (أو تاريخ النقل)
  - يُنشأ جدول جديد بـ `effectiveFrom` = تاريخ النقل
- يمكن الاحتفاظ بتاريخية الجداول (جدول WorkScheduleHistory) إذا رُغب لاحقًا

### 4.2 واجهة المستخدم
- تنبيه: "تم نقل الموظف إلى قسم X في تاريخ Y — الجدول يبدأ من ذلك التاريخ"
- عرض الجدول الحالي الفعّال فقط في القائمة الرئيسية

---

## 5. تجربة المستخدم (UX)

### 5.1 اختيار النوع أولاً
1. **الخطوة 1:** نوع الدوام (صباحي / خفر)
2. **الخطوة 2:** إذا خفر → اختيار النمط (1×1، 1×2، 1×3، ثابت)
3. **الخطوة 3:** وقت الدوام (من–إلى، استراحة)
4. **الخطوة 4:** اختيار الموظفين

### 5.2 نسخ ولصق
- تصدير الجدول الحالي إلى Excel/CSV
- استيراد من Excel (أعمدة: الاسم، القسم، النوع، النمط، من، إلى...)
- لصق من جدول بيانات (مثل Excel) في واجهة مخصصة

### 5.3 تطبيق جماعي
- **قالب سريع:** اختيار قالب (مثل "خفر 1×2، 07:00–19:00")
- **تطبيق على عدة موظفين:** اختيار الموظفين + "تطبيق القالب"
- زر "نفس الإعدادات للمختارين" — يطبق إعدادات الموظف الأول على الباقي

### 5.4 قوالب جاهزة
- قوالب افتراضية: "دوام صباحي عادي"، "خفر 1×1"، "خفر 1×2"، "خفر ثابت (سبت–ثلاثاء)"
- إمكانية إنشاء قوالب خاصة بقسم معيّن

---

## 6. العطل الرسمية

### 6.1 HolidayScope الحالي
- `MORNING_ONLY`: الدوام الصباحي فقط يستفيد
- `ALL`: الكل (يُعدّل لاحقًا لاستثناء الخفر)
- `CUSTOM`: أقسام محددة

### 6.2 التعديل المقترح
- منطق الحساب:
  - إذا `workType = MORNING` → يُحتسب العطل
  - إذا `workType = SHIFTS` → لا يُحتسب العطل (يعمل كيوم عادي)

---

## 7. ترتيب التنفيذ المقترح

| المرحلة | المهمة | الأولوية |
|---------|--------|----------|
| **1** | فلترة الموظفين حسب القسم في API | عالية |
| **2** | إضافة shiftPattern وتعديل Schema | عالية |
| **3** | واجهة اختيار النوع ثم النمط (صباحي/خفر + 1×1, 1×2...) | عالية |
| **4** | عرض الموظفين حسب القسم في صفحة الجداول | عالية |
| **5** | تطبيق جماعي / قالب سريع | متوسطة |
| **6** | دعم النسخ/اللصق والاستيراد | متوسطة |
| **7** | effectiveFrom/effectiveTo لنقل الموظفين | متوسطة |
| **8** | قوالب الجداول (ScheduleTemplate) | منخفضة |

---

## 8. مراجع عالمية

- **Shift rotations (1x1, 2-2-3, 4on/4off)** مستخدمة في الرعاية الصحية والطوارئ
- **قاعدة 11 ساعة راحة** بين الورديات (UK Working Time Directive)
- **تقويم دوري** يُحسب من تاريخ بداية الدورة
- **استثناء الخفر من العطل** شائع في المستشفيات والخدمات 24/7

---

## 9. صلاحيات مقترحة

```typescript
SCHEDULES_VIEW   // عرض الجداول
SCHEDULES_MANAGE // إدارة جميع الجداول (تجاوز فلتر القسم)
```

مدير القسم بدون SCHEDULES_MANAGE يرى ويعدّل جداول قسمه فقط.
