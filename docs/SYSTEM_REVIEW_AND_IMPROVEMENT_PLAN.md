# خطة مراجعة وتحسين النظام الشاملة
## نظام الموارد البشرية – مستشفى الحكيم العام

تم إعداد هذه الخطة لمقارنة النظام بأفضل الأنظمة من نفس النوع (إدارة إجازات، غيابات، موظفين، دوام) وتحديد النقوصات والتحسينات والميزات المقترحة مع ترتيب تنفيذ عملي.

---

## 1. نطاق المراجعة الحالي

### 1.1 ما يشمله النظام حالياً
| المجال | الميزات الحالية |
|--------|------------------|
| **المصادقة** | تسجيل دخول (بريد/كلمة مرور)، JWT، صلاحيات تفصيلية، تغيير كلمة المرور، ملف شخصي (اسم، هاتف، رمز وظيفي) |
| **الموظفون** | قائمة، بحث، ترقيم صفحات، إضافة/تعديل، استيراد CSV، إحصائيات (نشط/متوقف/صباحي/خفارات)، فلترة قسم ونوع دوام |
| **الأقسام** | قائمة، إضافة/تعديل، ربط مدير قسم |
| **الإجازات** | أنواع إجازات، طلبات إجازة، اعتماد/رفض، رصيد تراكمي، استحقاق شهري، تقويم إجازات، تقرير رسمي + طباعة |
| **الغيابات** | كشوف يومية (موظف بصمة)، إرسال لمدير البصمة، مصادقة يومية، حل التكرار (موظف في أكثر من كشف)، تقرير غيابات رسمي، منع تسجيل نفس الموظف مرتين في يوم واحد |
| **العطل** | إضافة/تعديل/حذف، نطاق (صباحي/الكل/مخصص) |
| **جداول الدوام** | جدول شهري لكل موظف، صباحي/خفارات، أنماط تناوب، نسخ شهر، اعتماد جدول، تقرير جدول رسمي |
| **التقارير** | مركز تقارير (كروت)، تقرير إجازات رسمي، كشف غيابات، جداول، تصدير PDF/Excel حيث مُطبّق |
| **المستخدمون والصلاحيات** | إدارة مستخدمين، صلاحيات تفصيلية، ربط أقسام لموظف البصمة |
| **سجل التدقيق** | أحداث (إنشاء/تعديل/حذف/اعتماد...) حسب الكيان والمستخدم والوقت |
| **التصميم** | RTL، سايدبار قابل للطي، قائمة حسب الصلاحيات، Breadcrumb، إشعارات (إن وُجدت)، ألوان مؤسسية |

---

## 2. الاختبار الشامل (Testing)

### 2.1 فجوات الاختبار الحالية
- لا يبدو وجود **اختبارات آلية (E2E أو Unit)** في المشروع.
- الاعتماد على الاختبار اليدوي فقط يزيد احتمال الأخطاء بعد أي تعديل.

### 2.2 خطة الاختبار المقترحة

| الأولوية | العنصر | الوصف |
|----------|--------|--------|
| **عالي** | **اختبار المسارات الحرجة (E2E)** | تسجيل الدخول → لوحة التحكم → قائمة الموظفين → إضافة إجازة → اعتماد إجازة. تسجيل غياب → إرسال كشف → حل تكرار → مصادقة. |
| **عالي** | **اختبار واجهات الـ API الحرجة** | POST إجازة، اعتماد/رفض، إضافة غياب للكشف، مصادقة يوم، حل تكرار، استحقاق الرصيد. |
| **متوسط** | **اختبار وحدات الخدمات** | `leave-requests.service` (حساب الأيام/الساعات، تداخل الإجازات)، `attendance-validation`، `absence-reports` (حل التكرار). |
| **منخفض** | **اختبار المكونات (اختياري)** | نماذج إضافة إجازة/موظف، حقول البحث والفلترة. |

### 2.3 أدوات مقترحة
- **E2E:** Playwright أو Cypress (مع دعم RTL وربط مع واجهة التطبيق).
- **API:** Jest + Supertest في الـ Backend.
- **تشغيل:** دمج في CI (مثلاً GitHub Actions) لتشغيل الاختبارات عند الـ push/PR.

---

## 3. مقارنة مع أفضل الأنظمة (Gap Analysis)

مقارنة مع أنظمة مثل BambooHR، Zoho People، OrangeHRM، وحلول محلية متقدمة:

### 3.1 نقوصات وظيفية (Features)

| الفجوة | الوصف | الأولوية |
|--------|--------|----------|
| **لوحة تحكم قابلة للتخصيص** | لا يمكن للمستخدم اختيار الودجات أو ترتيبها (مثلاً: إجازاتي المعلقة، غيابات الشهر، تنبيهات). | متوسطة |
| **تنبيهات وإشعارات مركزية** | إشعارات من نوع "طلب إجازة بانتظار الموافقة"، "تم اعتماد طلبك"، "رصيد منخفض". حالياً قد تكون جزئية أو غير موحدة. | عالية |
| **سير عمل موحد (Workflow)** | تدفق واضح: طلب → موافقة مدير → موافقة مدير إجازات (إن وُجدت مراحل). حالياً موجود لكن واجهة "سير العمل" الموحدة غير واضحة. | متوسطة |
| **تقارير جاهزة إضافية** | تقرير استهلاك الإجازات حسب القسم/الشهر، تقرير الغيابات حسب الموظف/الفترة، تقرير الرصيد الحالي لجميع الموظفين. | عالية |
| **تصدير البيانات** | تصدير موحد (Excel/CSV) للقوائم (موظفين، إجازات، غيابات) مع فلترة. | عالية |
| **بحث موحد (Global Search)** | بحث من الهيدر عن موظف/طلب إجازة/كشف غياب مع روابط سريعة. | متوسطة |
| **سجل نشاط الموظف** | صفحة موظف واحدة تعرض: بياناته، إجازاته، غياباته، جدول الدوام، الرصيد (Timeline أو تبويبات). | عالية |
| **إشعارات البريد الإلكتروني** | إرسال بريد عند إنشاء طلب إجازة، اعتماد، رفض (اختياري حسب الإعدادات). | متوسطة |
| **نسخ احتياطي واستعادة** | سياسة نسخ احتياطي لقاعدة البيانات مع توثيق. | عالية (عمليات) |
| **وضع عدم اتصال / PWA** | تحميل الصفحات الأساسية للعمل دون اتصال (اختياري). | منخفضة |

### 3.2 نقوصات واجهة المستخدم وتجربة الاستخدام (UI/UX)

| الفجوة | الوصف | الأولوية |
|--------|--------|----------|
| **حالات التحميل الموحدة** | توحيد Skeleton/Spinner في الجداول والقوائم والنماذج. | عالية |
| **حالات الفراغ (Empty State)** | رسالة ورسوم توضيحية عند عدم وجود بيانات (لا موظفين، لا طلبات، لا كشوف) مع إجراء واضح (إضافة أول موظف). | عالية |
| **معالجة الأخطاء في النماذج** | عرض أخطاء الـ API تحت الحقل المناسب وليس فقط Toast. | عالية |
| **التأكيد على الإجراءات الخطرة** | تأكيد موحد لحذف/إلغاء مصادقة/حذف غياب مع توضيح العواقب. | متوسطة (جزئياً موجود) |
| **التنقل السريع (Shortcuts)** | اختصارات لوحة المفاتيح للصفحات الرئيسية أو الإجراءات الشائعة. | منخفضة |
| **دعم الجوال (Responsive)** | التأكد من أن الجداول والنماذج والطباعة مناسبة للشاشات الصغيرة. | عالية |
| **الوصولية (a11y)** | تسميات للحقول، تركيز لوحة المفاتيح، contrast الألوان، أدوار ARIA. | متوسطة |
| **توحيد النماذج** | نفس نمط تسمية الحقول، عرض الخطأ، الأحجام (أزرار، حقول). | عالية |
| **الترقيم والفلترة** | توحيد حجم الصفحة (10/25/50)، عرض "من X إلى Y من إجمالي Z"، أزرار أول/سابق/تالي/آخر. | متوسطة |
| **البحث والفلترة** | حفظ فلتر البحث في الـ URL لسهولة المشاركة والعودة. | متوسطة |

### 3.3 نقوصات تقنية وأداء

| الفجوة | الوصف | الأولوية |
|--------|--------|----------|
| **Rate limiting على الـ API** | منع إساءة الاستخدام وتحميل الخادم. | عالية |
| **تحميل كسول للقوائم الطويلة** | Virtualization أو تحميل تدريجي للجداول الكبيرة. | متوسطة |
| **Caching و Stale-while-revalidate** | توحيد staleTime/queryClient للتقارير والقوائم. | متوسطة (جزئياً مُطبّق) |
| **توثيق الـ API** | Swagger/OpenAPI للمطورين والتكاملات المستقبلية. | متوسطة |
| **Logging موحد** | سجل أخطاء وطلبات في الـ Backend لتسهيل التشخيص. | عالية |

---

## 4. ميزات مقترحة للإضافة (Feature Additions)

### 4.1 مرحلة قصيرة المدى (1–2 شهر)

1. **صفحة ملف موظف واحد (Employee Profile)**
   - تبويبات: البيانات الأساسية، الإجازات، الغيابات، جدول الدوام، الرصيد.
   - روابط سريعة: إضافة إجازة له، تسجيل غياب، عرض جدول الشهر.

2. **تنبيهات مركزية (Notifications Center)**
   - أنواع: طلب إجازة جديد، اعتماد/رفض، تنبيه رصيد منخفض، تنبيه تكرار غياب.
   - تخزين في DB أو استخدام الإشعارات الحالية مع توسيعها وربطها بصفحات ذات صلة (Deep link).

3. **تقارير جاهزة إضافية**
   - تقرير استهلاك الإجازات (حسب القسم/الشهر).
   - تقرير الغيابات (موظف/فترة).
   - تقرير الأرصدة الحالية (Excel/PDF).

4. **تصدير موحد للقوائم**
   - زر "تصدير Excel/CSV" في صفحات الموظفين، الإجازات، الغيابات مع تطبيق الفلاتر الحالية.

5. **تحسين معالجة الأخطاء في النماذج**
   - عرض رسالة الخطأ من الـ API تحت الحقل المعني (مثلاً: الموظف، نوع الإجازة، التاريخ) مع الإبقاء على Toast للرسائل العامة.

### 4.2 مرحلة متوسطة المدى (2–4 أشهر)

6. **بحث موحد (Global Search)**
   - في الهيدر: إدخال بحث → نتائج: موظفون، طلبات إجازات، مع روابط.

7. **ودجات لوحة التحكم القابلة للتخصيص**
   - اختيار الودجات (إجازات معلقة، غيابات الشهر، إحصائيات الموظفين) وترتيبها (Drag & drop أو قائمة).

8. **إشعارات البريد الإلكتروني**
   - إعداد اختياري: إرسال بريد عند طلب إجازة، اعتماد، رفض.

9. **سير عمل الإجازات متعدد المراحل (اختياري)**
   - موافقة مدير مباشر ثم مدير إجازات مع عرض الحالة في الواجهة.

10. **توثيق API (Swagger)**
    - تفعيل في الـ Backend مع حماية المسارات الحساسة.

### 4.3 مرحلة طويلة المدى (4+ أشهر)

11. **نسخ احتياطي واستعادة**
    - سكربتات/أتمتة نسخ احتياطي لقاعدة البيانات مع توثيق الاستعادة.

12. **تطبيق جوال أو PWA**
    - تحسين التجربة على الجوال وربما PWA للتقارير والموافقات البسيطة.

13. **تكامل مع أنظمة خارجية**
    - استيراد/تصدير مع أنظمة الرواتب أو البصمة (إن وُجدت واجهات).

---

## 5. تحسينات واجهة المستخدم وتجربة الاستخدام (UI/UX)

### 5.1 توحيد التصميم

| العنصر | الإجراء |
|--------|---------|
| **Skeleton** | استخدام مكون واحد (مثلاً `TableSkeleton` / `PageSkeleton`) في كل الجداول والقوائم. |
| **Empty State** | مكون `EmptyState` موحد: أيقونة، عنوان، وصف، زر إجراء (مثل "إضافة أول موظف"). |
| **النماذج** | توحيد عرض التسمية، الحقل، رسالة الخطأ، والمسافات بين الحقول. |
| **الأزرار** | توحيد الأحجام (sm/default) وألوان الإجراءات (أساسي، ثانوي، خطر). |
| **الجداول** | توحيد ارتفاع الصفوف، المحاذاة (يمين للنص العربي)، وأزرار الإجراءات. |

### 5.2 تحسينات تفاعلية

| العنصر | الإجراء |
|--------|---------|
| **التأكيد على الحذف** | نافذة تأكيد موحدة مع جملة توضح العواقب (مثلاً: "سيتم حذف الموظف وجميع بياناته المرتبطة"). |
| **النجاح بعد الإجراء** | Toast نجاح + إغلاق النموذج + تحديث القائمة (موجود جزئياً؛ توحيده في كل الصفحات). |
| **الفلترة والبحث** | ربط الفلاتر بـ URL (query params) لسهولة المشاركة وإعادة فتح نفس العرض. |
| **الترقيم** | عرض "عرض 1–10 من 95" مع اختيار حجم الصفحة (10/25/50) وأزرار تنقل واضحة. |

### 5.3 الجوال والوصولية

| العنصر | الإجراء |
|--------|---------|
| **الجداول على الجوال** | تحويل الجدول إلى بطاقات (Cards) أو جدول قابل للتمرير الأفقي مع تثبيت أول عمود. |
| **النماذج** | حقول بعرض كامل على الشاشات الصغيرة، أزرار كبيرة قابلة للنقر. |
| **الوصولية** | تسميات `label` مرتبطة بـ `id`، ألوان بتباين كافٍ، دعم التنقل بلوحة المفاتيح. |

### 5.4 الطباعة والتصدير

| العنصر | الإجراء |
|--------|---------|
| **التقارير المطبوعة** | توحيد الهيدر والفوتر (شعار، عنوان، تاريخ الطباعة) وإخفاء عناصر الواجهة غير الضرورية عند الطباعة. |
| **PDF/Excel** | التأكد من أن التصدير يشمل البيانات المفلترة فقط وتنسيق واضح للعناوين والأعمدة. |

---

## 6. خطة التنفيذ المرحلية (Suggested Order)

### المرحلة أ: الأساس (أسبوعان)
- توحيد **حالات التحميل** (Skeleton) في الصفحات الرئيسية.
- إضافة **حالات الفراغ (Empty State)** في: الموظفين، الإجازات، الغيابات، الأقسام، المستخدمين.
- تحسين **عرض أخطاء النماذج** (ربط رسالة الخطأ بالحقل عند الإمكان).
- توثيق **خطة النسخ الاحتياطي** وقائمة فحص التشغيل (إن لم تكن موجودة).

### المرحلة ب: الملف والتنبيهات (أسبوعان)
- **صفحة ملف الموظف** (Employee Profile) مع تبويبات الإجازات والغيابات والجدول والرصيد.
- توسيع **مركز الإشعارات** (إن وُجد) أو إنشاؤه مع أنواع: إجازات، غيابات، تكرار، رصيد.
- ربط الإشعارات بصفحات ذات صلة (Deep link).

### المرحلة ج: التقارير والتصدير (أسبوعان)
- **تقرير استهلاك الإجازات** (حسب القسم/الشهر) مع طباعة/تصدير.
- **تقرير الغيابات** (فترة/موظف) مع تصدير.
- **تصدير موحد** (Excel/CSV) لصفحات الموظفين، الإجازات، الغيابات مع الفلاتر الحالية.

### المرحلة د: التحسينات والجودة (أسبوعان)
- **بحث موحد** من الهيدر (موظفون، إجازات) مع روابط سريعة.
- **ربط الفلاتر والبحث بـ URL** في الصفحات الرئيسية.
- **تحسين الاستجابة للجوال** للجداول والنماذج الحرجة.
- **Rate limiting** على واجهات الـ API الرئيسية.

### المرحلة هـ: الاختبار والأتمتة (مستمر)
- إضافة **اختبارات API** للطلبات الحرجة (إجازة، اعتماد، غياب، مصادقة، حل تكرار).
- إضافة **اختبار E2E** لمسار واحد كامل على الأقل (تسجيل دخول → إجازة → اعتماد).
- تشغيل الاختبارات في **CI** عند كل push/PR.

---

## 7. ملخص أولويات التنفيذ

| الأولوية | البند | النوع |
|----------|--------|--------|
| 1 | حالات التحميل والفراغ الموحدة | UI/UX |
| 2 | عرض أخطاء النماذج حسب الحقل | UI/UX |
| 3 | صفحة ملف الموظف (Profile) | ميزة |
| 4 | تنبيهات مركزية + ربط بصفحات | ميزة |
| 5 | تقارير إضافية + تصدير موحد | ميزة |
| 6 | تصدير Excel/CSV للقوائم | ميزة |
| 7 | ربط الفلاتر بـ URL | UI/UX |
| 8 | تحسين الجوال للجداول والنماذج | UI/UX |
| 9 | Rate limiting + توثيق API | تقني |
| 10 | اختبارات API و E2E + CI | اختبار |

---

يمكن استخدام هذه الوثيقة كمرجع لمراجعة النظام وتنفيذ التحسينات على مراحل، مع إمكانية تعديل الأولويات حسب موارد الفريق والجدول الزمني.

---

## 8. سجل التنفيذ

### تم تنفيذ المرحلة أ (الأساس) — 2025
- **مكون EmptyState موحد** (`frontend/src/components/shared/empty-state.tsx`): أيقونة، عنوان، وصف، زر إجراء اختياري (مع أيقونة). دعم وضع `compact`.
- **مكون ErrorState موحد** (`frontend/src/components/shared/error-state.tsx`): عرض خطأ مع زر "إعادة المحاولة" اختياري.
- **تطبيق EmptyState في الصفحات:** الموظفين، الأقسام، الإجازات، الغيابات (قائمة الأرشيف)، المستخدمون، العطل، أنواع الإجازات، سجل التدقيق.
- **تطبيق ErrorState + TableSkeleton:** الموظفين، الإجازات، المستخدمون (مع زر إعادة المحاولة و TableSkeleton للتحميل).
- **تحسين عرض أخطاء النماذج (ربط بالحقل):** مؤجل للمرحلة التالية؛ يمكن إضافة عرض رسالة الخطأ من الـ API في أعلى النموذج أو تحت زر الإرسال.

### تم تنفيذ المرحلة ب (الملف والتنبيهات) — 2025
- **صفحة ملف الموظف (Employee Profile)** (`/dashboard/employees/[id]`):
  - تبويبات: البيانات الأساسية، الإجازات، الغيابات، جدول الدوام، الرصيد.
  - البيانات الأساسية: الاسم، الوظيفة، القسم، المدير، نوع الدوام، الرصيد المسجل، تاريخ بداية الرصيد.
  - الإجازات: جدول طلبات الإجازة مع رابط "طلب إجازة".
  - الغيابات: جدول سجل الغيابات.
  - جدول الدوام: عرض جدول الشهر الحالي مع رابط لصفحة جداول الدوام.
  - الرصيد: الرصيد الفعلي، الأساس، الاستحقاق الشهري، أيام الإجازة في الشهر.
- **ربط من قائمة الموظفين:** الاسم في الجدول أصبح رابطاً يفتح ملف الموظف.
- **مركز الإشعارات:** يبقى كما هو (التوسيع لاحقاً إن رُغب).

### تم تنفيذ المرحلة ج (التقارير والتصدير) — 2025
- **أداة تصدير CSV موحدة** (`frontend/src/lib/export.ts`): دالة `downloadCSV(headers, rows, filename)` مع BOM لدعم العربية.
- **تصدير قائمة الموظفين:** زر "تصدير CSV" في صفحة الموظفين؛ يُصدّر حتى 100 سجل مع تطبيق الفلاتر الحالية (بحث، قسم، نوع دوام، عرض المتوقفين، الترتيب).
- **تصدير طلبات الإجازات:** زر "تصدير CSV" في صفحة الإجازات؛ يُصدّر حتى 100 سجل مع تطبيق الفلاتر (بحث، حالة، قسم، نوع إجازة، من–إلى).
- **تصدير قائمة الغيابات:** زر "تصدير CSV" في واجهة الغيابات (القديمة)؛ يُصدّر حتى 100 سجل غياب.
