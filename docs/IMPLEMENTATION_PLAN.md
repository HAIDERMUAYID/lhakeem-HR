# خطة تنفيذ تطوير نظام الموارد البشرية – مستشفى الحكيم العام

## الهدف
تحويل النظام إلى مستوى Enterprise / Hospital-grade: UI/UX احترافي، Sidebar حديث، إشعارات ذكية، صلاحيات دقيقة، مركز تقارير، وطباعة رسمية A4 — **بدون كسر الوظائف الحالية**.

---

## المرحلة 1: الأساس (Design System + Shell + Auth)

### 1.1 Design System موحد
- **الخطوط:** الإبقاء على Cairo (موجود) أو إضافة IBM Plex Arabic كبديل؛ تطبيق `--font-cairo` على كل الصفحات.
- **الألوان:** توحيد استخدام `primary-*` و `success`/`warning`/`error` من tailwind؛ إضافة CSS variables إن لزم.
- **المكونات:** مراجعة Card, Button, Input, Table, Modal في `components/ui` لضمان نفس الـ border-radius والـ spacing (مثلاً `rounded-xl`, `p-4`/`p-6`).
- **الأيقونات:** الاعتماد على lucide-react فقط؛ توحيد حجم الأيقونات (مثلاً h-5 w-5 في القوائم).
- **RTL:** التأكد من `dir="rtl"` و `lang="ar"` في layout؛ مراجعة margin/padding لـ RTL.
- **Responsive:** استخدام نفس breakpoints (sm/md/lg)؛ قوائم قابلة للطي على الجوال.

**معايير القبول:** أي صفحة تدخلها تحس بنفس الهوية؛ لا ألوان أو أشكال متضاربة.

### 1.2 Sidebar & App Shell
- **الشعار:** استبدال الحرف "ح" بصورة شعار المستشفى (أو SVG) + نص "HR System – مستشفى الحكيم".
- **Collapse:** زر لطي الشريط الجانبي يعرض الأيقونات فقط؛ عند التوسيع يعود العرض الكامل مع النصوص.
- **الصلاحيات:** ربط كل عنصر قائمة بـ permission (مثل `employees.view`, `reports.view`)؛ إخفاء العناصر غير المصرح بها.
- **Active route:** تمييز المسار الحالي بوضوح (خلفية primary + لون أبيض).
- **Header:** اسم المستخدم + زر الإشعارات (جرس) + قائمة حساب (تغيير كلمة المرور، خروج).

**معايير القبول:** Sidebar ثابت وسلس؛ collapse/expand بدون كسر؛ عدم ظهور صفحات/أزرار غير مصرح بها.

### 1.3 Authentication (Username بدل Email)
- **Backend:** إضافة حقل `username` (فريد) في نموذج User؛ جعل تسجيل الدخول بـ username + password؛ الإبقاء على email كاختياري أو إزالته لاحقاً.
- **Login:** واجهة تسجيل الدخول: حقل "اسم المستخدم" + "كلمة المرور" فقط.
- **Profile:** حقول: الاسم، رقم الهاتف، (اختياري) كود وظيفي؛ تحديث JWT/payload ليعكس username.

### 1.4 الإعدادات وتغيير كلمة المرور
- **صفحة الإعدادات:** قسم "تغيير كلمة المرور" (كلمة المرور الحالية، الجديدة، تأكيد) مع التحقق من القوة.
- **API:** `PATCH /api/auth/change-password` أو ضمن user profile؛ حماية بـ JWT.

---

## المرحلة 2: الصلاحيات (Fine-grained)

### 2.1 نموذج الصلاحيات
- **قائمة صلاحيات منظمة:**  
  `employees.view | create | edit | archive | import | print`  
  `departments.view | create | edit`  
  `leaves.view | create | approve | print | export`  
  `attendance.view | create | approve | print`  
  `schedules.view | print`  
  `reports.view | export`  
  `users.manage | permissions.manage`  
  `settings.change_password`
- **Backend:** تحديث `PERMISSIONS` وربط كل endpoint بـ `@RequirePermissions(...)`.
- **قوالب أدوار:** Admin (الكل)، HR، Fingerprint Officer، Fingerprint Manager، Viewer؛ قابلة للتخصيص من واجهة الصلاحيات.

### 2.2 واجهات المستخدمين والصلاحيات
- **شاشة Users:** إنشاء مستخدم (username, name, phone, jobCode اختياري، كلمة مرور) + تعيين الصلاحيات (checkboxes حسب الوحدات والإجراءات).
- **شاشة Permissions:** عرض الصلاحيات كشجرة/قائمة (Modules → Actions) مع إمكانية تعيينها للمستخدم أو القالب.
- **UI Guard:** إخفاء الأزرار والروابط التي لا يملك المستخدم صلاحيتها.
- **API Guard:** إرجاع 403 Forbidden لأي endpoint غير مصرح.

**معايير القبول:** لا زر/صفحة بدون permission؛ أي وصول غير مصرح يُمنع في الواجهة والـ API.

---

## المرحلة 3: الإشعارات (Deep Link)

### 3.1 Notification Center
- **نموذج إشعار:** عنوان، وصف، وقت، نوع (info/warn/action)، وربط (entity + entityId + route).
- **Deep link:** عند النقر ينتقل إلى الصفحة والسجل المقصود (مثلاً `/dashboard/leaves?id=xxx` أو تفاصيل الطلب).
- **حالات:** Unread/Read؛ "تعليم الكل كمقروء".
- **مصادر الإشعارات:** طلبات إجازة بانتظار الاعتماد، تنبيهات تعارض، تقارير مُرسلة، إلخ — بدون سبام.

**معايير القبول:** الضغط على إشعار "طلب إجازة" يفتح صفحة الطلب مباشرة؛ لا إشعارات زائدة.

---

## المرحلة 4: تحسين واجهات الصفحات

### 4.1 Dashboard
- ترحيب "مرحباً [اسم المستخدم]".
- KPIs ورسوم بيانية رسمية (بدون مبالغة).
- إجراءات سريعة حسب الصلاحيات.

### 4.2 الموظفون
- قائمة: بحث، فلاتر، جدول متقدم (ترتيب، pagination، إظهار/إخفاء أعمدة).
- إضافة موظف: نموذج بـ Tabs (Basic / Job / Schedule / …) مع validation قوية.

### 4.3 الأقسام، أنواع الإجازات، العطل، الحضور، الجداول
- تحسين بصري موحد: أزرار واضحة، جداول قوية، فلاتر وبحث، نفس نمط البطاقات والألوان.

**معايير القبول:** تحسين واضح بدون تغيير المنطق الأساسي؛ تجربة أسرع وأنظف.

---

## المرحلة 5: مركز التقارير (Reports Hub)

### 5.1 إعادة بناء صفحة التقارير
- **بطاقات تقارير:** غيابات، إجازات، الجداول الشهرية، العطل، ساعات العمل.
- **كل تقرير:** لوحة فلاتر (فترة، قسم، …) + ملخص KPI + معاينة + طباعة/تصدير PDF.
- **الصلاحيات:** الوصول حسب `reports.view` أو صلاحيات نوع التقرير.

**معايير القبول:** التقارير قابلة للوصول حسب الصلاحية؛ workflow واضح: فترة/فلتر → معاينة → طباعة/PDF.

---

## المرحلة 6: الطباعة الرسمية (A4)

### (A) تقرير الغيابات (يومي/فترة)
- رأس: وزارة الصحة / دائرة صحة النجف / مستشفى الحكيم العام + شعار.
- ملخص KPI (عدد الغائبين، صباحي/خفارة، أقسام).
- جدول رسمي.
- تذييل: توقيع مسؤول البصمة + توقيع المدير.

### (B) جدول الدوام الشهري — صفحة لكل قسم
- اختيار شهر (مثلاً فبراير 2026).
- عند الطباعة: كل قسم في صفحة مستقلة (Page Break per department).
- عنوان الصفحة: "جدول الدوام الشهري – [الشهر] – قسم [X]".
- أعمدة: الاسم الرباعي، العنوان الوظيفي، نوع الدوام، وقت الدوام (12h AM/PM)، أيام الدوام، مجموع ساعات العمل الشهرية.
- تذييل توقيعات لكل صفحة.

### (C) تقرير الإجازات
- (موجود ومحسّن مسبقاً) KPI + جدول مع أيام/ساعات حسب نوع الإجازة؛ رأس وتذييل توقيعات.

**معايير القبول:** A4 بدون قص نص؛ Page breaks صحيحة؛ تصميم رسمي؛ قابل لتصدير PDF.

---

## المرحلة 7: سجل التدقيق (اختياري)

- تصنيف الأحداث: Create, Edit, Approve, Delete, Print, Export, Login.
- حقول: Entity, EntityId, Actor, Time, Before/After (إن أمكن).
- فلاتر حسب التاريخ، المستخدم، النوع، الكيان.

**معايير القبول:** سجل مفهوم ومفيد للتدقيق.

---

## المرحلة 8: الأداء والجودة

- عدم تغيير الجداول/البيانات بدون ضرورة.
- تحسينات آمنة؛ استخدام React Query للـ caching وتقليل الطلبات.
- عدم تكرار استعلامات ثقيلة.

**معايير القبول:** سرعة أعلى؛ لا أخطاء؛ لا كسر لمسارات النظام الحالية.

---

## ترتيب التنفيذ المقترح

1. **المرحلة 1** (Design System، Sidebar، Auth، تغيير كلمة المرور) — أساس كل ما يليه.
2. **المرحلة 2** (الصلاحيات الدقيقة + شاشات Users/Permissions).
3. **المرحلة 3** (الإشعارات + Deep link).
4. **المرحلة 4** (تحسين واجهات الصفحات).
5. **المرحلة 5** (Reports Hub).
6. **المرحلة 6** (قوالب الطباعة A4).
7. **المرحلة 7** (سجل التدقيق).
8. **المرحلة 8** (مراجعة أداء وجودة).

---

## ملاحظات تقنية

- **Frontend:** Next.js 14، React Query، Tailwind، Cairo، lucide-react.
- **Backend:** NestJS، Prisma، JWT، Guards مع `RequirePermissions`.
- **قاعدة البيانات:** إضافة أعمدة عند الحاجة (username، phone، jobCode، إلخ) عبر migrations دون كسر الحقول الحالية.

---

## تطبيق الهجرة (بعد المرحلة 1)

لتشغيل هجرة المستخدمين (username، phone، job_code، جعل email اختياري):

```bash
cd backend
npx prisma migrate deploy
# أو للتطوير:
npx prisma migrate dev
```

ثم تحديث المستخدمين الحاليين إن لزم (الـ seed يضبط username من email تلقائياً عند التشغيل).
